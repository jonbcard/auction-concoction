:javascript
  $(function(){
    var viewModel =  profilesViewModel();
    ko.applyBindings(viewModel);

  });

  function Profile(viewModel){
    this.id = ko.property();
    this.name = ko.property();
    this.premium_type = ko.property("PERCENT");
    this.premium_amount = ko.property();
    this.is_default = ko.property(false);
    
    this.premium_symbol = ko.dependentObservable(function(){
      return (this.premium_type() == "PERCENT" ? "%" : "$");
    }, this);

    this.premium_formatted = ko.dependentObservable(function(){
      if(this.premium_symbol() && this.premium_amount()){
        return this.premium_symbol() + this.premium_amount().toFixed(2);
      }
      return null; 
    }, this);

    this.resetAmount = function(){
      this.premium_amount().temp = null;
    }.bind(this);

    // functions
    this.edit = function(){
      viewModel.activeProfile(this);
      $("#premium_type").buttonset();
      $("#editDialog").dialog({title:"Edit Profile"});
    }

    this.cancel = function(){
      viewModel.activeProfile.reset();
      $("#editDialog").dialog("close");
    }

    this.save = function(){
      var wrapper = this;
      var id = wrapper().id;
      if(!id()){
        // create the record
        wrapper.save("profiles/new.json", function(result){
            viewModel.profiles.push(wrapper());
            $("#editDialog").dialog("close");
            $.growlUI("Profile Created"); 
        });
      } else {
        // save existing record
        wrapper.save("profiles/" + id() + ".json", function(result){
              $("#editDialog").dialog("close");
              $.growlUI("Profile Saved"); 
        });
      }
    }
  }

  var profilesViewModel = function(){
    this.profiles = ko.observableArray([]);
    this.activeProfile = ko.model();

    this.newProfile = function() {
      new Profile(this).edit();
    };

    // Load the initial state from server
    
    this.load = function() {
      var self = this;
      $.get("profiles.json", function(data) {
        var all = ko.mapToModelList(Profile, data, self);
        self.profiles(all);
      });
    }
    
    load();
  }

#editDialog{ :style=>"display:none;"}
  %div{:'data-bind' => "template: {name:'editForm', data: activeProfile}"}

%script{:type => "text/x-jquery-tmpl", :id => "editForm"}
  .flash
    .message.error{:'data-bind' => "visible: activeProfile.hasErrors()"}
      Errors occurred while saving the profile.
  %form.form{:id => 'profileForm', :'data-bind' => 'submit:save'}
    .group
      %label{:for=>:name}Name:
      %span.error{:'data-bind' => "text: name.errors"}
      %br
      %input.required{:'data-bind' => "value: name.temp"}
    .group
      %label Auction House Premium:
      %span.error{:'data-bind' => "text: premium_type.errors"}
      %br
        #premium_type
          %input{:id => "prem_fixed", :name => "premium_type", :type => "radio", :value => "FIXED", :'data-bind' => "checked: premium_type.temp"}
          %label{:for => "prem_fixed"} Fixed
          %input{:id => "prem_pct", :name => "premium_type", :type => "radio", :value => "PERCENT", :'data-bind' => "checked: premium_type.temp"}
          %label{:for => "prem_pct"} Percent
        %br
        %input{:style => "width:75px", :'data-bind' => "value: premium_amount"}
    .group
      %label Default:
      %span.error{:'data-bind' => "text: is_default.errors"}
      %br
      %input{:type => 'checkbox', :'data-bind' => "checked: is_default.temp"}
    %button.form_button{:type => 'submit'}
      Save
    &nbsp;&nbsp;|&nbsp;&nbsp;
    =link_to("Cancel", "", :class => :button_to, :'data-bind' => "click : cancel")

%script{:type => "text/x-jquery-tmpl", :id => "row"}
  %td
    %span{:'data-bind' => "text: name"}
  %td
    %span{:'data-bind' => "text: premium_formatted"} 
  %td
    %input{:type => 'checkbox', :'data-bind' => "checked: is_default", :disabled => true}
  %td.last
    %span.clickable{:'data-bind' => "click: edit, clickBubble: false"}
      =image_tag 'page_white_edit.png'

.block
  .content
    #title
      %h2 Auction Profiles
    #title-menu
      %button#new{:href => "", :'data-bind' => "click : newProfile, icon: 'ui-icon-plus'"}
        New
    .inner
      %table.table{:'data-bind' =>  "dataTable: { dataSource: profiles, rowTemplate: 'row', columns: ['name', 'premium_amount', 'is_default', null], 
                                         options:{sPaginationType:'full_numbers', } }"}
        %thead
          %th.first=mat(:profile, :name)
          %th Premium Amount
          %th=mat(:profile, :default)
          %th.last="&nbsp;"